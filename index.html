<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Diagram Creator Pro</title>
    
    <!-- Meta informaci√≥n -->
    <meta name="description" content="Herramienta profesional para crear diagramas de red">
    <meta name="author" content="Network Diagram Creator">
    <meta name="keywords" content="red, diagrama, network, topology, cisco, switch, router">
    
    <!-- CSS cr√≠tico en l√≠nea para evitar FOUC -->
    <style>
        /* CSS cr√≠tico para pantalla de carga */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            overflow: hidden;
            line-height: 1.5;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 16px;
        }
        
        .loading-content {
            text-align: center;
            max-width: 400px;
            padding: 2rem;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-progress {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-bar {
            height: 100%;
            background: white;
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .loading-details {
            margin-top: 1rem;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8d7da;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #721c24;
        }
        
        .error-content {
            text-align: center;
            max-width: 500px;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #dc3545;
        }
        
        .error-content h2 {
            margin-bottom: 1rem;
            color: #dc3545;
        }
        
        .error-actions {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
            margin: 0.25rem;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        /* Esconder contenido principal inicialmente */
        .main-content,
        .header {
            display: none;
        }
    </style>
    
    <!-- CSS principal -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="fixed.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/icons/favicon.ico">
    <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">
</head>
<body>
    <!-- Pantalla de carga -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Network Diagram Creator</h2>
            <p>Inicializando aplicaci√≥n profesional de diagramas de red...</p>
            <div class="loading-progress">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="loading-details">
                <p id="loading-status">Preparando entorno...</p>
                <p id="loading-step">Paso 1 de 6</p>
            </div>
        </div>
    </div>

    <!-- Pantalla de error -->
    <div id="error-screen" class="error-screen">
        <div class="error-content">
            <h2>üö® Error de Inicializaci√≥n</h2>
            <p id="error-message">Ha ocurrido un error al cargar la aplicaci√≥n.</p>
            <details id="error-details" style="margin-top: 1rem; text-align: left;">
                <summary>Detalles t√©cnicos</summary>
                <pre id="error-stack" style="font-size: 12px; background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; white-space: pre-wrap; word-wrap: break-word;"></pre>
            </details>
            <div class="error-actions">
                <button class="btn btn-primary" onclick="location.reload()">
                    üîÑ Recargar P√°gina
                </button>
                <button class="btn btn-secondary" onclick="resetApplication()">
                    üîß Reiniciar Aplicaci√≥n
                </button>
                <a href="mailto:support@example.com" class="btn btn-secondary">
                    üìß Reportar Error
                </a>
            </div>
        </div>
    </div>

    <!-- Header Principal -->
    <header class="header" id="main-header">
        <div class="header-container">
            <!-- Logo y t√≠tulo -->
            <div class="header-brand">
                <img src="assets/icons/logo.svg" alt="Logo" class="brand-logo" onerror="this.style.display='none'" style="width: 32px; height: 32px; border-radius: 4px;">
                <h1 class="brand-title">Network Diagram Creator</h1>
                <span class="brand-version">Pro v2.0</span>
            </div>
            
            <!-- Toolbar principal -->
            <div class="toolbar" id="main-toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-btn" id="new-btn" title="Nuevo proyecto (Ctrl+N)">
                        <span class="icon">üìÑ</span>
                        <span class="label">Nuevo</span>
                    </button>
                    <button class="toolbar-btn" id="open-btn" title="Abrir proyecto (Ctrl+O)">
                        <span class="icon">üìÇ</span>
                        <span class="label">Abrir</span>
                    </button>
                    <button class="toolbar-btn" id="save-btn" title="Guardar proyecto (Ctrl+S)">
                        <span class="icon">üíæ</span>
                        <span class="label">Guardar</span>
                    </button>
                </div>
                
                <div class="toolbar-separator"></div>
                
                <div class="toolbar-group">
                    <button class="toolbar-btn active" id="select-tool" title="Seleccionar (V)">
                        <span class="icon">üîç</span>
                    </button>
                    <button class="toolbar-btn" id="device-tool" title="Agregar dispositivo (D)">
                        <span class="icon">üñ•Ô∏è</span>
                    </button>
                    <button class="toolbar-btn" id="connection-tool" title="Conectar dispositivos (C)">
                        <span class="icon">üîó</span>
                    </button>
                    <button class="toolbar-btn" id="text-tool" title="Agregar texto (T)">
                        <span class="icon">üìù</span>
                    </button>
                </div>
                
                <div class="toolbar-separator"></div>
                
                <div class="toolbar-group">
                    <button class="toolbar-btn" id="zoom-in" title="Acercar (+)">
                        <span class="icon">üîç+</span>
                    </button>
                    <button class="toolbar-btn" id="zoom-out" title="Alejar (-)">
                        <span class="icon">üîç-</span>
                    </button>
                    <button class="toolbar-btn" id="zoom-fit" title="Ajustar vista (0)">
                        <span class="icon">‚öè</span>
                    </button>
                </div>
                
                <div class="toolbar-spacer"></div>
                
                <!-- Status y configuraci√≥n -->
                <div class="toolbar-group">
                    <div class="status-indicator" id="connection-status" title="Estado de conexi√≥n">
                        <span class="status-dot online"></span>
                        <span class="status-text">En l√≠nea</span>
                    </div>
                    <button class="toolbar-btn" id="settings-btn" title="Configuraci√≥n">
                        <span class="icon">‚öôÔ∏è</span>
                    </button>
                    <button class="toolbar-btn" id="help-btn" title="Ayuda (F1)">
                        <span class="icon">‚ùì</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Contenido Principal -->
    <div class="main-content" id="main-content">
        <!-- Sidebar izquierdo -->
        <aside class="sidebar" id="main-sidebar">
            <!-- Secci√≥n de capas se insertar√° aqu√≠ por LayerManager -->
            
            <!-- Secci√≥n de dispositivos -->
            <div class="sidebar-section" id="devices-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">üñ•Ô∏è</span>
                        Dispositivos
                    </h3>
                    <button class="collapse-btn" title="Colapsar secci√≥n">
                        <span>‚àí</span>
                    </button>
                </div>
                <div class="section-content">
                    <div class="search-box">
                        <input type="text" id="device-search" placeholder="Buscar dispositivos...">
                        <span class="search-icon">üîç</span>
                    </div>
                    
                    <div class="device-categories" id="device-categories">
                        <!-- Categor√≠as de dispositivos se cargar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>
            </div>
            
            <!-- Secci√≥n de plantillas -->
            <div class="sidebar-section" id="templates-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">üìã</span>
                        Plantillas
                    </h3>
                    <button class="collapse-btn" title="Colapsar secci√≥n">
                        <span>‚àí</span>
                    </button>
                </div>
                <div class="section-content">
                    <div class="template-grid" id="template-grid">
                        <!-- Plantillas se cargar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>
            </div>
            
            <!-- Secci√≥n de propiedades -->
            <div class="sidebar-section" id="properties-section" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">‚öôÔ∏è</span>
                        Propiedades
                    </h3>
                    <button class="collapse-btn" title="Colapsar secci√≥n">
                        <span>‚àí</span>
                    </button>
                </div>
                <div class="section-content" id="properties-content">
                    <!-- Propiedades del elemento seleccionado -->
                </div>
            </div>
        </aside>

        <!-- √Årea de canvas principal -->
        <main class="canvas-area" id="canvas-area">
            <!-- Barra de estado del canvas -->
            <div class="canvas-status-bar">
                <div class="canvas-info">
                    <span id="canvas-coordinates">X: 0, Y: 0</span>
                    <span class="separator">|</span>
                    <span id="canvas-zoom">Zoom: 100%</span>
                    <span class="separator">|</span>
                    <span id="canvas-selection">0 seleccionados</span>
                </div>
                <div class="canvas-controls">
                    <button class="canvas-btn" id="grid-toggle" title="Mostrar/Ocultar grilla">
                        <span class="icon">‚öè</span>
                    </button>
                    <button class="canvas-btn" id="snap-toggle" title="Ajustar a grilla">
                        <span class="icon">‚ö°</span>
                    </button>
                    <button class="canvas-btn" id="rulers-toggle" title="Mostrar/Ocultar reglas">
                        <span class="icon">üìè</span>
                    </button>
                </div>
            </div>
            
            <!-- Contenedor del canvas -->
            <div class="canvas-container" id="canvas-container">
                <!-- Canvas principal se crear√° aqu√≠ din√°micamente -->
                <div class="canvas-placeholder" id="canvas-placeholder">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">üñºÔ∏è</div>
                        <h3>√Årea de Trabajo</h3>
                        <p>Arrastra dispositivos aqu√≠ para comenzar a crear tu diagrama</p>
                        <div class="placeholder-actions">
                            <button class="btn btn-primary" id="start-tutorial">
                                üìö Iniciar Tutorial
                            </button>
                            <button class="btn btn-secondary" id="load-template">
                                üìã Cargar Plantilla
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Panel de propiedades flotante (opcional) -->
        <div class="floating-panel" id="floating-properties" style="display: none;">
            <div class="panel-header">
                <h4>Propiedades</h4>
                <button class="panel-close">√ó</button>
            </div>
            <div class="panel-content" id="floating-properties-content">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <!-- Contenedor de notificaciones -->
    <div class="notifications-container" id="notifications-container">
        <!-- Las notificaciones se crear√°n din√°micamente aqu√≠ -->
    </div>

    <!-- Contenedor de modales -->
    <div class="modal-container" id="modal-container">
        <!-- Los modales se crear√°n din√°micamente aqu√≠ -->
    </div>

    <!-- Scripts cr√≠ticos del core - ORDEN CORREGIDO -->
    
    <!-- 1. Variables globales y funciones de utilidad cr√≠ticas -->
    <script>
        // Variables globales para debugging y configuraci√≥n
        window.DEBUG_MODE = localStorage.getItem('debug-mode') === 'true' || 
                           window.location.search.includes('debug=true');
        
        // Configuraci√≥n global de la aplicaci√≥n
        window.APP_CONFIG = {
            version: '2.0.0',
            apiUrl: 'https://api.networkdiagram.com',
            maxDevices: 1000,
            maxConnections: 2000,
            autoSaveInterval: 30000,
            debugMode: window.DEBUG_MODE
        };

        // Funciones de utilidad para manejo de errores y UI
        function resetApplication() {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar la aplicaci√≥n? Se perder√°n los datos no guardados.')) {
                localStorage.clear();
                sessionStorage.clear();
                location.reload();
            }
        }

        function showErrorDetails(error) {
            const errorDetails = document.getElementById('error-details');
            const errorStack = document.getElementById('error-stack');
            
            if (errorDetails && errorStack) {
                errorStack.textContent = error.stack || error.message || 'No hay detalles disponibles';
                errorDetails.style.display = 'block';
            }
        }

        // Funci√≥n para actualizar el progreso de carga
        function updateLoadingProgress(percent, status, step) {
            const progressBar = document.getElementById('progress-bar');
            const statusElement = document.getElementById('loading-status');
            const stepElement = document.getElementById('loading-step');
            
            if (progressBar) {
                progressBar.style.width = Math.min(100, Math.max(0, percent)) + '%';
            }
            
            if (statusElement && status) {
                statusElement.textContent = status;
            }
            
            if (stepElement && step) {
                stepElement.textContent = step;
            }
            
            if (window.DEBUG_MODE) {
                console.log(`üìä Progreso: ${percent}% - ${status}`);
            }
        }

        // Funci√≥n para mostrar error en pantalla
        function showErrorScreen(error) {
            const loadingScreen = document.getElementById('loading-screen');
            const errorScreen = document.getElementById('error-screen');
            const errorMessage = document.getElementById('error-message');
            
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (errorScreen) errorScreen.style.display = 'flex';
            
            if (errorMessage) {
                errorMessage.textContent = error.message || 'Error desconocido en la inicializaci√≥n';
            }
            
            showErrorDetails(error);
            
            console.error('üî¥ Error mostrado en pantalla:', error);
        }

        // Funci√≥n para ocultar pantalla de carga y mostrar aplicaci√≥n
        function showApplication() {
            const loadingScreen = document.getElementById('loading-screen');
            const mainHeader = document.getElementById('main-header');
            const mainContent = document.getElementById('main-content');
            
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 300);
            }
            
            if (mainHeader) {
                mainHeader.style.display = 'block';
                setTimeout(() => {
                    mainHeader.style.opacity = '1';
                }, 100);
            }
            
            if (mainContent) {
                mainContent.style.display = 'flex';
                setTimeout(() => {
                    mainContent.style.opacity = '1';
                }, 200);
            }
            
            console.log('‚úÖ Aplicaci√≥n mostrada');
        }

        // Detectar capacidades del navegador
        function detectBrowserCapabilities() {
            const capabilities = {
                canvas: !!document.createElement('canvas').getContext,
                webgl: !!document.createElement('canvas').getContext('webgl'),
                localStorage: !!window.localStorage,
                workers: !!window.Worker,
                offscreenCanvas: !!window.OffscreenCanvas,
                performance: !!window.performance
            };
            
            console.log('üîç Capacidades del navegador:', capabilities);
            return capabilities;
        }

        // Inicializar detecci√≥n temprana
        detectBrowserCapabilities();
    </script>

    <!-- 2. StateManager - DEBE SER EL PRIMERO -->
    <script src="assets/js/state-manager.js"></script>

    <!-- 3. Sistema de inicializaci√≥n -->
    <script src="assets/js/app-initialization.js"></script>
    
    <!-- 4. Managers principales (en orden de dependencias) -->
    <script src="assets/js/core/layer-manager.js"></script>
    <script src="assets/js/core/canvas-manager.js"></script>
    
    <!-- 5. Managers adicionales (con fallbacks) -->
    <script>
        // DeviceManager b√°sico si no existe el archivo
        if (!window.DeviceManager) {
            console.log('üì¶ Creando DeviceManager b√°sico...');
            window.DeviceManager = {
                initialized: false,
                devices: new Map(),
                
                async initialize() {
                    console.log('üîß Inicializando DeviceManager b√°sico...');
                    this.initialized = true;
                    console.log('‚úÖ DeviceManager b√°sico inicializado');
                },
                
                addDevice(device) {
                    if (!device.id) {
                        device.id = `device_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    }
                    
                    this.devices.set(device.id, device);
                    
                    if (window.StateManager) {
                        window.StateManager.addDevice(device);
                    }
                    
                    console.log(`‚ûï Dispositivo agregado: ${device.name || device.id}`);
                    return device.id;
                },
                
                removeDevice(deviceId) {
                    this.devices.delete(deviceId);
                    
                    if (window.StateManager) {
                        window.StateManager.removeDevice(deviceId);
                    }
                    
                    console.log(`‚ûñ Dispositivo eliminado: ${deviceId}`);
                    return true;
                },
                
                getDevice(deviceId) {
                    return this.devices.get(deviceId);
                },
                
                getAllDevices() {
                    return Array.from(this.devices.values());
                },
                
                loadDeviceTypes(deviceTypes) {
                    console.log('üìö Tipos de dispositivos cargados:', Object.keys(deviceTypes));
                    return Promise.resolve();
                }
            };
        }

        // ConnectionManager b√°sico
        if (!window.ConnectionManager) {
            console.log('üì¶ Creando ConnectionManager b√°sico...');
            window.ConnectionManager = {
                initialized: false,
                connections: new Map(),
                
                async initialize() {
                    console.log('üîß Inicializando ConnectionManager b√°sico...');
                    this.initialized = true;
                    console.log('‚úÖ ConnectionManager b√°sico inicializado');
                },
                
                addConnection(connection) {
                    if (!connection.id) {
                        connection.id = `conn_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    }
                    
                    this.connections.set(connection.id, connection);
                    
                    if (window.StateManager) {
                        window.StateManager.addConnection(connection);
                    }
                    
                    console.log(`üîó Conexi√≥n agregada: ${connection.id}`);
                    return connection.id;
                }
            };
        }

        // NotificationManager b√°sico
        if (!window.NotificationManager) {
            console.log('üì¶ Creando NotificationManager b√°sico...');
            window.NotificationManager = {
                initialized: false,
                
                async initialize() {
                    this.initialized = true;
                    console.log('‚úÖ NotificationManager b√°sico inicializado');
                },
                
                show(message, type = 'info') {
                    console.log(`${type.toUpperCase()}: ${message}`);
                    
                    // Crear notificaci√≥n visual simple
                    const container = document.getElementById('notifications-container');
                    if (container) {
                        const notification = document.createElement('div');
                        notification.className = `notification ${type}`;
                        notification.innerHTML = `
                            <div class="notification-content">
                                <span class="notification-message">${message}</span>
                                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                            </div>
                        `;
                        
                        container.appendChild(notification);
                        
                        // Auto-remover despu√©s de 5 segundos
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 5000);
                    }
                }
            };
        }

        // Otros managers b√°sicos
        ['UIManager', 'ToolbarManager', 'SidebarManager', 'ModalManager', 'FileManager', 
         'ExportManager', 'TemplateManager', 'ValidationManager', 'SelectionManager'].forEach(managerName => {
            if (!window[managerName]) {
                window[managerName] = {
                    initialized: false,
                    async initialize() {
                        this.initialized = true;
                        console.log(`‚úÖ ${managerName} b√°sico inicializado`);
                    }
                };
            }
        });
    </script>

    <!-- 6. Aplicaci√≥n principal -->
    <script src="assets/js/main.js"></script>

    <!-- 7. Inicializaci√≥n principal -->
    <script>
        // Inicializaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üöÄ Iniciando Network Diagram Creator v2.0...');
                
                updateLoadingProgress(5, 'Validando entorno del navegador...', 'Paso 1 de 6');
                
                // Verificar dependencias cr√≠ticas
                const criticalDependencies = ['StateManager', 'AppInitializer'];
                for (const dep of criticalDependencies) {
                    if (!window[dep]) {
                        throw new Error(`Dependencia cr√≠tica faltante: ${dep}`);
                    }
                }
                
                updateLoadingProgress(15, 'Inicializando sistema de estado...', 'Paso 2 de 6');
                
                // Inicializar StateManager primero
                if (!window.StateManager.initialized) {
                    await window.StateManager.initialize();
                }
                
                updateLoadingProgress(30, 'Configurando sistema de inicializaci√≥n...', 'Paso 3 de 6');
                
                // Crear e inicializar el AppInitializer
                const initializer = new AppInitializer();
                await initializer.initialize();
                
                updateLoadingProgress(60, 'Inicializando aplicaci√≥n principal...', 'Paso 4 de 6');
                
                // Inicializar aplicaci√≥n principal
                if (window.NetworkDiagramApp) {
                    await window.NetworkDiagramApp.initialize();
                }
                
                updateLoadingProgress(85, 'Configurando interfaz de usuario...', 'Paso 5 de 6');
                
                // Configurar manejadores adicionales
                setupApplicationHandlers();
                
                updateLoadingProgress(100, '¬°Aplicaci√≥n lista!', 'Completado');
                
                // Peque√±a pausa antes de mostrar la aplicaci√≥n
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Mostrar aplicaci√≥n
                showApplication();
                
                console.log('‚úÖ Network Diagram Creator iniciado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error fatal en inicializaci√≥n:', error);
                showErrorScreen(error);
                
                // Reportar error si hay sistema de analytics
                if (window.analytics) {
                    window.analytics.track('initialization_error', {
                        error: error.message,
                        stack: error.stack,
                        userAgent: navigator.userAgent
                    });
                }
            }
        });

        // Configurar manejadores adicionales de la aplicaci√≥n
        function setupApplicationHandlers() {
            // Manejador de redimensionado de ventana
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    if (window.CanvasManager && window.CanvasManager.initialized) {
                        window.CanvasManager.handleResize();
                    }
                }, 150);
            });
            
            // Manejador de visibilidad de p√°gina
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Pausar animaciones cuando la p√°gina no es visible
                    if (window.CanvasManager && window.CanvasManager.pauseAnimations) {
                        window.CanvasManager.pauseAnimations();
                    }
                } else {
                    // Reanudar animaciones
                    if (window.CanvasManager && window.CanvasManager.resumeAnimations) {
                        window.CanvasManager.resumeAnimations();
                    }
                }
            });
            
            // Manejador de beforeunload para advertir sobre cambios no guardados
            window.addEventListener('beforeunload', (e) => {
                if (window.StateManager?.getState().project?.hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '¬øEst√°s seguro de que quieres salir? Hay cambios sin guardar.';
                }
            });
            
            // Configurar shortcuts globales
            document.addEventListener('keydown', (e) => {
                // Ignorar si est√° en un input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                // Ctrl+S: Guardar
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (window.NetworkDiagramApp && window.NetworkDiagramApp.saveProject) {
                        window.NetworkDiagramApp.saveProject();
                    }
                }
                
                // Ctrl+Z: Deshacer
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    if (window.StateManager) {
                        window.StateManager.undo();
                    }
                }
                
                // Ctrl+Y: Rehacer
                if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    if (window.StateManager) {
                        window.StateManager.redo();
                    }
                }
                
                // Delete: Eliminar seleccionado
                if (e.key === 'Delete') {
                    if (window.NetworkDiagramApp && window.NetworkDiagramApp.deleteSelected) {
                        window.NetworkDiagramApp.deleteSelected();
                    }
                }
                
                // F1: Ayuda
                if (e.key === 'F1') {
                    e.preventDefault();
                    if (window.HelpManager && window.HelpManager.show) {
                        window.HelpManager.show();
                    }
                }
                
                // Escape: Cancelar operaci√≥n actual
                if (e.key === 'Escape') {
                    if (window.NetworkDiagramApp && window.NetworkDiagramApp.cancelCurrentOperation) {
                        window.NetworkDiagramApp.cancelCurrentOperation();
                    }
                }
                
                // Herramientas r√°pidas
                if (!e.ctrlKey && !e.altKey) {
                    switch(e.key.toLowerCase()) {
                        case 'v':
                            if (window.NetworkDiagramApp && window.NetworkDiagramApp.setActiveTool) {
                                window.NetworkDiagramApp.setActiveTool('select');
                            }
                            break;
                        case 'd':
                            if (window.NetworkDiagramApp && window.NetworkDiagramApp.setActiveTool) {
                                window.NetworkDiagramApp.setActiveTool('device');
                            }
                            break;
                        case 'c':
                            if (window.NetworkDiagramApp && window.NetworkDiagramApp.setActiveTool) {
                                window.NetworkDiagramApp.setActiveTool('connection');
                            }
                            break;
                        case 't':
                            if (window.NetworkDiagramApp && window.NetworkDiagramApp.setActiveTool) {
                                window.NetworkDiagramApp.setActiveTool('text');
                            }
                            break;
                        case '+':
                        case '=':
                            if (window.NetworkDiagramApp && window.NetworkDiagramApp.zoomIn) {
                                window.NetworkDiagramApp.zoomIn();
                            }
                            break;
                        case '-':
                            if (window.NetworkDiagramApp && window.NetworkDiagramApp.zoomOut) {
                                window.NetworkDiagramApp.zoomOut();
                            }
                            break;
                        case '0':
                            if (window.NetworkDiagramApp && window.NetworkDiagramApp.zoomToFit) {
                                window.NetworkDiagramApp.zoomToFit();
                            }
                            break;
                    }
                }
            });
            
            console.log('‚öôÔ∏è Manejadores de aplicaci√≥n configurados');
        }

        // Funciones para debugging (solo en modo debug)
        if (window.DEBUG_MODE) {
            window.debugApp = {
                getState: () => window.StateManager?.getState(),
                getLayers: () => window.LayerManager?.getAllLayers(),
                getDevices: () => window.DeviceManager?.getAllDevices(),
                getConnections: () => window.ConnectionManager?.connections,
                getCanvas: () => window.CanvasManager,
                getApp: () => window.NetworkDiagramApp,
                resetApp: resetApplication,
                showError: (msg) => showErrorScreen(new Error(msg)),
                version: window.APP_CONFIG.version,
                
                // M√©todos de utilidad para debugging
                addTestDevice: () => {
                    if (window.NetworkDiagramApp && window.NetworkDiagramApp.addDeviceToCenter) {
                        window.NetworkDiagramApp.addDeviceToCenter('router');
                    }
                },
                
                clearCanvas: () => {
                    if (window.StateManager) {
                        window.StateManager.reset();
                    }
                },
                
                exportState: () => {
                    const state = window.StateManager?.exportState();
                    console.log('üìÑ Estado exportado:', state);
                    return state;
                },
                
                showStats: () => {
                    const stats = {
                        devices: window.StateManager?.getState().devices?.size || 0,
                        connections: window.StateManager?.getState().connections?.size || 0,
                        layers: window.StateManager?.getState().layers?.size || 0,
                        zoom: window.StateManager?.getState().canvas?.zoom || 1,
                        initialized: {
                            StateManager: window.StateManager?.initialized,
                            LayerManager: window.LayerManager?.initialized,
                            CanvasManager: window.CanvasManager?.initialized,
                            DeviceManager: window.DeviceManager?.initialized,
                            App: window.NetworkDiagramApp?.initialized
                        }
                    };
                    console.table(stats);
                    return stats;
                }
            };
            
            console.log('üêõ Modo debug activado. Comandos disponibles en window.debugApp:');
            console.log('  - debugApp.showStats() - Mostrar estad√≠sticas');
            console.log('  - debugApp.addTestDevice() - Agregar dispositivo de prueba');
            console.log('  - debugApp.clearCanvas() - Limpiar canvas');
            console.log('  - debugApp.exportState() - Exportar estado');
            console.log('  - debugApp.getState() - Ver estado actual');
        }

        // Configurar eventos espec√≠ficos de la interfaz
        document.addEventListener('DOMContentLoaded', () => {
            // Configurar botones del placeholder
            const startTutorialBtn = document.getElementById('start-tutorial');
            if (startTutorialBtn) {
                startTutorialBtn.addEventListener('click', () => {
                    if (window.TutorialManager && window.TutorialManager.start) {
                        window.TutorialManager.start();
                    } else {
                        window.NotificationManager?.show('Tutorial no disponible en esta versi√≥n', 'info');
                    }
                });
            }

            const loadTemplateBtn = document.getElementById('load-template');
            if (loadTemplateBtn) {
                loadTemplateBtn.addEventListener('click', () => {
                    if (window.TemplateManager && window.TemplateManager.showTemplateDialog) {
                        window.TemplateManager.showTemplateDialog();
                    } else {
                        window.NotificationManager?.show('Abriendo selector de plantillas...', 'info');
                    }
                });
            }

            // Configurar tooltips y ayuda contextual
            const elementsWithTooltips = document.querySelectorAll('[title]');
            elementsWithTooltips.forEach(element => {
                element.addEventListener('mouseenter', (e) => {
                    // Aqu√≠ se podr√≠a implementar tooltips personalizados
                });
            });
        });

        // Configuraci√≥n de performance y monitoreo
        if (window.performance && window.performance.mark) {
            window.performance.mark('app-init-start');
            
            window.addEventListener('load', () => {
                window.performance.mark('app-init-end');
                window.performance.measure('app-initialization', 'app-init-start', 'app-init-end');
                
                const measures = window.performance.getEntriesByType('measure');
                measures.forEach(measure => {
                    console.log(`‚è±Ô∏è ${measure.name}: ${measure.duration.toFixed(2)}ms`);
                });
            });
        }

        // Manejo de errores no capturados adicionales
        window.addEventListener('error', (event) => {
            console.error('üî¥ Error global no manejado:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('üî¥ Promise rechazada no manejada:', event.reason);
            event.preventDefault(); // Prevenir que aparezca en la consola del navegador
        });
    </script>

    <!-- Analytics y tracking (opcional) -->
    <script>
        // Configurar analytics b√°sico (reemplazar con tu proveedor)
        if (!window.DEBUG_MODE && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            (function() {
                // Aqu√≠ ir√≠a el c√≥digo de analytics (Google Analytics, etc.)
                console.log('üìä Analytics configurado para producci√≥n');
                
                // Ejemplo de tracking de eventos importantes
                window.trackEvent = function(eventName, properties = {}) {
                    if (window.gtag) {
                        window.gtag('event', eventName, properties);
                    }
                    
                    if (window.DEBUG_MODE) {
                        console.log('üìà Event tracked:', eventName, properties);
                    }
                };
                
                // Track de inicializaci√≥n exitosa
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(() => {
                        if (window.NetworkDiagramApp?.initialized) {
                            window.trackEvent('app_initialized', {
                                version: window.APP_CONFIG.version,
                                userAgent: navigator.userAgent,
                                loadTime: performance.now()
                            });
                        }
                    }, 2000);
                });
                
            })();
        } else {
            console.log('üìä Analytics deshabilitado en modo desarrollo');
            window.trackEvent = function(eventName, properties = {}) {
                console.log('üìà Event (debug):', eventName, properties);
            };
        }
    </script>

    <!-- Service Worker para cache (opcional) -->
    <script>
        // Registrar Service Worker para mejor rendimiento
        if ('serviceWorker' in navigator && location.protocol === 'https:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('üë∑ Service Worker registrado:', registration);
                    })
                    .catch(error => {
                        console.log('‚ùå Error registrando Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>